<script>
    const socket = new WebSocket('ws://localhost:8887');
    socket.addEventListener('open', e => {
        console.debug('socket open');
    });
    socket.addEventListener('close', e => {
        console.debug('socket closed');
    });
    socket.addEventListener('message', e => {
        console.debug(b64_to_utf8(e.data));
    })

    function utf8_to_b64(str) {
        return window.btoa(unescape(encodeURIComponent(str)));
    }

    function b64_to_utf8(str) {
        return decodeURIComponent(escape(window.atob(str)));
    }


    const sendSocket = data => {
        socket.send(utf8_to_b64(data));
    }

    const messageTypes = {
        clientGetAuth: "CLIENT_GET_AUTH",
        clientGetAuthToken: "CLIENT_GET_AUTH_TOKEN",
        clientGetConversations: "CLIENT_GET_CONVERSATIONS",
        clientGetMessages: "CLIENT_GET_MESSAGES",
        clientSendMessage: "CLIENT_SEND_MESSAGE",
        clientCreateNewConversation: "CLIENT_CREATE_NEW_CONVERSATION",
        serverPing: "SERVER_PING",
        serverNewMessage: "SERVER_NEW_MESSAGE",
        serverNewConversation: "SERVER_NEW_CONVERSATION",
        serverErr: "SERVER_ERR"
    };

    // recipients: list<uuid>
    const createCreateConversationMessage = (recipients, name) => JSON.stringify({
        type: messageTypes.clientCreateNewConversation,
        recipients,
        name
    });

    // token: str
    const createGetAuthMessage = token => JSON.stringify({
        type: messageTypes.clientGetAuth,
        token
    });

    // userName, passwordHash: string
    const createGetAuthTokenMessage = (userName, passwordHash) => JSON.stringify({
        type: messageTypes.clientGetAuthToken,
        userName,
        passwordHash
    });

    const createGetConversationsMessage = conversationId => JSON.stringify({
        type: messageTypes.clientGetConversations,
        conversationId
    });

    // conversationId: uuid
    const createGetMessagesMessage = conversationId => JSON.stringify({
        type: messageTypes.clientGetMessages,
        conversationId
    });

    // conversationId: uuid
    // content: str
    const createSendMessageToConversationMessage = (conversationId, content) => JSON.stringify({
        type: messageTypes.clientSendMessage,
        conversationId,
        content
    });

    const getMessageType = message => JSON.parse(message).type;
</script>
