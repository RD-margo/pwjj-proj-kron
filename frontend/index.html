<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script type="module">
    import { createPubsub } from './pubsub.js'

    const $ = id => document.getElementById(id);
    const { publish, subscribe } = createPubsub();

    function utf8_to_b64(str) {
        return window.btoa(unescape(encodeURIComponent(str)));
    }

    function b64_to_utf8(str) {
        return decodeURIComponent(escape(window.atob(str)));
    }

    let state = {
        socket: null
    };


    const sendSocket = data => {
        state.socket.send(utf8_to_b64(data));
    }

    const messageTypes = {
        clientGetAuth: "CLIENT_GET_AUTH",
        clientGetAuthToken: "CLIENT_GET_AUTH_TOKEN",
        clientGetConversations: "CLIENT_GET_CONVERSATIONS",
        clientGetMessages: "CLIENT_GET_MESSAGES",
        clientSendMessage: "CLIENT_SEND_MESSAGE",
        clientCreateNewConversation: "CLIENT_CREATE_NEW_CONVERSATION",
        serverPing: "SERVER_PING",
        serverNewMessage: "SERVER_NEW_MESSAGE",
        serverNewConversation: "SERVER_NEW_CONVERSATION",
        serverErr: "SERVER_ERR"
    };

    // recipients: list<uuid>
    const createCreateConversationMessage = (recipients, name) => JSON.stringify({
        type: messageTypes.clientCreateNewConversation,
        recipients,
        name
    });

    // token: str
    const createGetAuthMessage = token => JSON.stringify({
        type: messageTypes.clientGetAuth,
        token
    });

    // userName, passwordHash: string
    const createGetAuthTokenMessage = (userName, passwordHash) => JSON.stringify({
        type: messageTypes.clientGetAuthToken,
        userName,
        passwordHash
    });

    const createGetConversationsMessage = conversationId => JSON.stringify({
        type: messageTypes.clientGetConversations,
        conversationId
    });

    // conversationId: uuid
    const createGetMessagesMessage = conversationId => JSON.stringify({
        type: messageTypes.clientGetMessages,
        conversationId
    });

    // conversationId: uuid
    // content: str
    const createSendMessageToConversationMessage = (conversationId, content) => JSON.stringify({
        type: messageTypes.clientSendMessage,
        conversationId,
        content
    });

    const getMessageType = message => JSON.parse(message).type;

    const login = e => {
        const username = $("input-username").value;
        const password = $("input-password").value;

        var packet = createGetAuthTokenMessage(username, password);
        const unsubscribe = subscribe(data => { handleLogin(data); unsubscribe(); });
        sendSocket(packet);
    }

    const handleLogin = result => {
        if(result == null) {
            console.error("login error!");
            return;
        }

        console.log("login success! " + JSON.stringify(result));
    }

    const main = () => {
        state.socket = new WebSocket('ws://localhost:8887');
        state.socket.addEventListener('open', e => {
            console.debug('socket open');
            subscribe(data => console.error(data));
        });
        state.socket.addEventListener('close', e => {
            console.debug('socket closed');
        });
        state.socket.addEventListener('message', e => {
            var data = JSON.parse(b64_to_utf8(e.data));
            publish(data);
        });
    }

    const exports = {main, login};
    for(const i in exports)
        window[i] = exports[i];
</script>


<body onload="main()">
    <main>
        <div id="login-screen">
            <div id="logo-text">Visual Communicator</div>
            <form onsubmit="return false">
                <div>
                    <input type="text" id="input-username" placeholder="Nazwa użytkownika">
                </div>
                <div>
                    <input type="text" id="input-password" placeholder="Hasło">
                </div>
                <div>
                    <button type="submit" onclick="login()">Zaloguj się</button>
                </div>
            </form>
        </div>
    </main>
</body>